{
  "branch": "codex/cultivar-reference-link-cutover",
  "agree": true,
  "verification_commands_for_every_step": [
    "pnpm lint",
    "npx tsc --noEmit",
    "pnpm test",
    "pnpm test:e2e"
  ],
  "tasks": [
    {
      "step": 1,
      "id": "add-cultivar-reference-id-to-link-procedure-input",
      "completed": true,
      "change": "Update `listing.linkAhs` to accept `cultivarReferenceId` as primary input (keep `ahsId` optional temporarily for compatibility). Resolve `ahsId` from cultivar reference server-side.",
      "files": ["src/server/api/routers/listing.ts"],
      "success_criteria": [
        "linkAhs can link by cultivar reference id without using raw SQL.",
        "Existing callers still compile during transition."
      ]
    },
    {
      "step": 2,
      "id": "update-ahs-search-to-return-cultivar-reference-id",
      "completed": true,
      "change": "Change `ahs.search` response shape to include `cultivarReferenceId` for each selectable row. Keep existing display fields (`name`, etc.).",
      "files": ["src/server/api/routers/ahs.ts", "src/types/index.ts"],
      "success_criteria": [
        "Search results include stable cultivar reference id.",
        "No UI breakage from response shape change."
      ]
    },
    {
      "step": 3,
      "id": "wire-ahs-select-to-emit-cultivar-reference-id",
      "completed": true,
      "change": "Update AHS select component callback payload so selection provides `cultivarReferenceId` and display metadata.",
      "files": [
        "src/components/ahs-listing-select.tsx",
        "src/components/ahs-listing-link.tsx"
      ],
      "success_criteria": [
        "Selecting an AHS entry gives cultivar reference id to caller.",
        "TypeScript types are explicit and strict."
      ]
    },
    {
      "step": 4,
      "id": "switch-link-unlink-ui-flow-to-cultivar-reference",
      "completed": true,
      "change": "Update `AhsListingLink` to call `listing.linkAhs` using `cultivarReferenceId` only. Keep unlink unchanged (it should clear both linkage fields).",
      "files": ["src/components/ahs-listing-link.tsx"],
      "success_criteria": [
        "Link action no longer depends on client-passed `ahsId`.",
        "Unlink still persists after Save and dialog close."
      ]
    },
    {
      "step": 5,
      "id": "support-create-listing-with-cultivar-reference-id",
      "completed": true,
      "change": "Update listing create flow to pass and accept `cultivarReferenceId` from create dialog. Derive `ahsId` server-side as transitional back-compat if needed.",
      "files": [
        "src/app/dashboard/listings/_components/create-listing-dialog.tsx",
        "src/server/api/routers/listing.ts"
      ],
      "success_criteria": [
        "Create with selected AHS entry works via cultivar reference id.",
        "Title autofill and sync behavior remain unchanged."
      ]
    },
    {
      "step": 6,
      "id": "move-read-paths-to-cultivar-reference-source-of-truth",
      "completed": true,
      "change": "For listing fetch/query includes, prefer `cultivarReference -> ahsListing` for display data. Keep fallback to legacy `listing.ahsListing` only where needed during transition.",
      "files": [
        "src/server/api/routers/listing.ts",
        "src/server/api/routers/public.ts",
        "src/server/db/getPublicListings.ts"
      ],
      "success_criteria": [
        "Listing cards/dialog/table still show AHS details correctly.",
        "No regressions in summary/hybridizer/year fields."
      ]
    },
    {
      "step": 7,
      "id": "remove-ahsid-from-listing-update-api-surface",
      "completed": true,
      "change": "Ensure `listing.update` remains strictly form-only (`listingFormSchema`), with no `ahsId` branch logic.",
      "files": [
        "src/server/api/routers/listing.ts",
        "src/types/schemas/listing.ts"
      ],
      "success_criteria": [
        "No code path updates AHS link through generic form save.",
        "AHS linking is only via dedicated link/unlink procedures."
      ]
    },
    {
      "step": 8,
      "id": "update-unit-tests-for-new-contract",
      "completed": true,
      "change": "Adjust unit tests to assert link behavior through `linkAhs` + `cultivarReferenceId` path and ensure update mutation does not own AHS link state.",
      "files": [
        "tests/dual-write-cultivar-ref.test.ts",
        "tests/ahs-listing-link.test.tsx"
      ],
      "success_criteria": [
        "Unit tests cover link, unlink, missing cultivar reference, and update isolation."
      ]
    },
    {
      "step": 9,
      "id": "update-e2e-seeds-and-create-edit-flow",
      "completed": true,
      "change": "Ensure E2E seeds provide valid cultivar references and keep create/edit flow assertion that unlink remains unlinked after Save.",
      "files": [
        "tests/e2e/utils/seed-create-edit-listing.ts",
        "tests/e2e/create-edit-listing-flow.e2e.ts",
        "tests/e2e/utils/ahs-listings.ts"
      ],
      "success_criteria": [
        "Create/edit flow passes with new linkage model.",
        "Regression case (unlink -> save) remains green."
      ]
    },
    {
      "step": 10,
      "id": "cleanup-deprecated-ahsid-callers-after-cutover",
      "completed": true,
      "change": "Remove temporary compatibility input/branches that allowed direct `ahsId` in link procedures once all callers are migrated.",
      "files": [
        "src/server/api/routers/listing.ts",
        "src/server/api/routers/ahs.ts",
        "src/components/ahs-listing-link.tsx"
      ],
      "success_criteria": [
        "No app-level caller passes `ahsId` for linking.",
        "API surface is clean and cultivar-reference-first."
      ]
    }
  ]
}
