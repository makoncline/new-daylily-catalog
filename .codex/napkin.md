# Napkin

## Log

- 2026-02-23 - cache dedupe pattern - To avoid duplicated public profile cache wrappers without pulling broad public-cache deps into route tests, add a narrow shared module (`src/server/db/public-profile-cache.ts`) and re-export it from `public-cache.ts`.
- 2026-02-23 - local e2e cache bypass policy - Even when local Playwright passes with cache enabled, keeping `PLAYWRIGHT_LOCAL_E2E` bypass in `createServerCache` preserves deterministic no-cache test runs and previous repo behavior.
- 2026-02-23 - t3 baseline cache default - create-t3-app template `query-client.ts` uses `staleTime: 30 * 1000` by default (SSR anti-refetch baseline); our experiment override to `staleTime: 0`, `gcTime: 0`, and always-refetch is intentionally more aggressive and should be treated as a policy decision, not assumed template behavior.
- 2026-02-23 - public catalog test typing - `PublicCatalogSearchClient` tests need `PublicCatalogListing[]`; minimal `{id,title}` fixtures should go through a local typed factory (`as PublicCatalogListing`) to keep behavior-focused tests small while passing `tsc --noEmit`.
- 2026-02-23 - dashboard test timing verification - Re-checked `tests/dashboard-db-list-membership-sync.test.tsx` without timeout: it passes alone (~3.7s) but times out at 5s when run with other dashboard DB integration tests; timeout bump is for runtime variance, not assertion changes.
- 2026-02-23 - test strategy correction - I started adapting production code to satisfy snapshot-implementation tests; user clarified tests should be updated for intended behavior of new caching strategy instead of preserving old implementation-detail assertions.
- 2026-02-23 - integration timing flake - `tests/dashboard-db-list-membership-sync.test.tsx` is stable in isolation but can exceed default 5s in full suite; scoped timeout increase to 10s fixed suite reliability without changing assertions.
- 2026-02-23 - next segment-config self-miss - I switched route `revalidate` exports to imported config constants and Next 16 build failed with `Invalid segment configuration export`; keep route segment config as literals and annotate with searchable `CACHE_LITERAL_REF` comments.
- 2026-02-23 - shell glob self-miss - I hit `zsh: missing delimiter for 'u' glob qualifier` by running `rg` against `src/app/(public)` without quoting; always quote App Router paths with parentheses/brackets in shell commands.
- 2026-02-23 - public caching target definition - User wants static/ISR (24h) for `/`, `/catalogs`, `/{slug}`, `/{slug}?page=n`, and `/cultivar/{slug}`; `/{slug}/search` must stay non-static, non-robots, and use 24h stale-while-revalidate behavior.
- 2026-02-23 - dashboard refresh scope decision - User confirmed dashboard strategy: keep incremental `since` sync triggers and manual full refresh path, remove global tRPC mutate invalidate-all, remove sidebar 60s polling.
- 2026-02-23 - cache scope correction - I started removing dashboard TanStack DB cursor sync state as "cache"; user clarified TanStack DB internals should not count for this experiment, so keep those mechanisms unchanged.
- 2026-02-23 - cache-removal experiment pattern - For "remove caching" requests in this repo, strip `unstable_cache`/React `cache()` wrappers, remove query prefetch warmups, disable persistence modules with no-op exports, and keep only route-level ISR `revalidate` exports on static pages.
- 2026-02-21 - id-format assumption self-miss - I initially gated proxy canonical lookup to numeric IDs only; this app also uses non-numeric `User.id` values in tests/fixtures, so query-preserving canonical redirects must not assume numeric IDs.
- 2026-02-21 - seo redirect preference update - User wants `/{userId}` -> `/{slug}` canonicalization to stay server-side for SEO; preserve query params in proxy/server redirect path instead of client `router.replace`.
- 2026-02-21 - force-static redirect gotcha self-miss - Adding `searchParams` to `src/app/(public)/[userSlugOrId]/page.tsx` did not preserve query params on canonical redirect (`/{id}` still became `/{slug}` without query); handle query-preserving canonicalization in proxy instead of server page props.
- 2026-02-21 - redirect query preservation correction - User expects canonical redirect from `/{userId}` to `/{slug}` to keep incoming query params (e.g. `viewing`, `utm_*`); previous behavior dropped them.
- 2026-02-21 - tags composition pass - Refactored `TagDesignerPanel` from one monolithic render into explicit composed sections (`Header`, `Controls`, `Layout`, `Preview`) and extracted template/custom-size blocks as dedicated components to reduce inline branching and prop-mode complexity.
- 2026-02-21 - first-response e2e mismatch - `tests/e2e/public-profile-first-response.e2e.ts` can fail on `expect(html).not.toMatch(/template id="B:\\d+"/)` because first HTML now includes React streaming markers (`B:*`/`S:*`) while still containing page content; unrelated to `/dashboard/tags` changes.
- 2026-02-21 - tags print border preference - Printed tags should have no outer border in the print document CSS.
- 2026-02-21 - tags print sizing mode - User wants print output as one tag per page with page dimensions exactly matching the selected tag size; implement with dynamic `@page size` and forced page breaks per tag.
- 2026-02-21 - tags selection + full-detail adjustment - Add `Remove all` control in selected-listings area, and for `full detail` template keep first/second rows same as default (title row, then hybridizer/year/ploidy row with ploidy moved off the title line).
- 2026-02-21 - tags template set update - Built-in templates should be narrowed to three options: renamed default (`name + hybridizer + year + ploidy + qr`), `name + qr`, and `full detail` inspired by the example photo layout while staying on the default 1x3.5 tag size preset.
- 2026-02-21 - tags empty-cell spacing - In `/dashboard/tags`, empty field values must still render their configured cells so each tag keeps identical row/column geometry; do not drop cells based on missing content.
- 2026-02-21 - tags template controls refinement - User wants template picker to be non-native (shadcn-style), with delete action on each saved-template row in the picker, and "Save as template" moved into Layout actions only when layout is custom.
- 2026-02-21 - tags text handling update - For `/dashboard/tags`, user wants overflow instead of truncation, plus an explicit `fit` mode that shrinks text to available cell width.
- 2026-02-21 - tags overflow/fit scope correction - Overflow/fit must be per-cell controls (checkboxes), not a global tag-level selector; defaults are overflow off, fit on.
- 2026-02-21 - tags defaults + wrap update - `/dashboard/tags` cells should align on row baselines, default font sizes are title 22 and all other fields 16, and each cell needs a Wrap toggle defaulting off.
- 2026-02-21 - tags mode exclusivity update - Overflow/Fit/Wrap checkboxes should behave as mutually exclusive per-cell modes; checking one clears the others.
- 2026-02-21 - tags default layout update - Default layout should be Title row first, then Hybridizer/Year/Ploidy second row; title size 22 centered, others size 16 with Hybridizer + Ploidy centered and Year left.
- 2026-02-21 - tags QR link stability - QR links on dashboard tags should target `/{userId}?viewing={listingId}` (stable id route), not slug-based URLs.
- 2026-02-21 - tags dimension constraint - Tag dimensions must remain exact even when QR is enabled; use fixed `height` (not `min-height`) for preview and print tag containers.
- 2026-02-21 - tags QR fit correction - When QR is shown, fit-size calculations must subtract the reserved right-side QR area or text will still clip into the QR zone.
- 2026-02-21 - tags QR default - Layout-level QR toggle should default enabled (`showQrCode: true`), including fallback for older saved state without that field.
- 2026-02-21 - tags template flow - Add layout-level templates select with default + import, share current layout as JSON from Layout section, and set placeholder sample `userId` so QR is visible in sample preview mode.
- 2026-02-21 - tags template expansion - Added built-in templates (default, big-name+metadata, name/year/hybridizer/ploidy, name+QR, minimal), plus save/delete for user templates and exact-match label beside Layout title (`custom` when unmatched).
- 2026-02-21 - self-mistake parse guard - Large JSX callback patch introduced an extra closing `);`; after complex edits run lint immediately and inspect the exact line before further changes.
- 2026-02-20 - scope correction self-miss - I first added tag printing as a selected-row action on manage-list, then user clarified it must be a dedicated dashboard page; when feature placement is ambiguous, confirm page-level scope early.
- 2026-02-20 - tags UX correction - For `/dashboard/tags`, keep the tag designer inline at the top of the page (not in a dialog), with per-field style controls (font size + basic text styles), editable labels, left/right slot placement, and move up/down ordering.
- 2026-02-20 - print reliability pattern - Browser popup flows can fail for print; a hidden iframe + `contentWindow.print()` from the click handler is a more reliable print trigger than `window.open(...).print()`.
- 2026-02-20 - test rerun pattern - `pnpm test` showed a transient `tests/dashboard-db-collections.test.tsx` failure (`AbortSignal` + timeout) once, then passed on immediate rerun; if this recurs, rerun the single file and then full suite before treating it as deterministic.
- 2026-02-20 - lint blocker - `@typescript-eslint/no-unnecessary-type-assertion` flagged `(field as TagFieldConfig).textAlign`; use `field.textAlign` directly.
- 2026-02-20 - posthog verification pattern - Fastest proof path is Playwright with `localStorage.ph_debug=true` and checking console for `[PostHog.js] send "event_name"` plus `browser_network_requests` showing `https://us.i.posthog.com/e` `200`.
- 2026-02-20 - agent-browser click flake - In this repo/session, some `agent-browser click` calls on cursor-interactive refs stalled with no output; fall back to Playwright MCP tools for deterministic network-level verification.
- 2026-02-20 - posthog wizard backend flake - Wizard can fail after successful OAuth with `No chunk id map found` and repeated `401 Authentication required`; use manual Next.js integration as fallback.
- 2026-02-20 - posthog prod-only guard - Gate both `instrumentation-client.ts` init and `capturePosthogEvent` helper by `process.env.NODE_ENV === "production"` so dev/local never emit analytics even if a key appears.
- 2026-02-20 - posthog ownership cleanup - Keep PostHog initialization in `instrumentation-client.ts` only; `capturePosthogEvent` should just gate and call `posthog.capture` to avoid duplicate init logic.
- 2026-02-20 - ordering guard - For the public `/{slug}` Lists section, keep the synthetic `For Sale` card first in DOM order so it appears first in the grid; back this with a test to prevent regressions.
- 2026-02-20 - db path correction - For local prod snapshot checks in this worktree, the usable DB is `prisma/local-prod-copy-daylily-catalog.db` (the repo-root `local-prod-copy-daylily-catalog.db` may exist as an empty placeholder).
- 2026-02-20 - patch regression self-check - While adding new props to JSX I briefly rendered `PublicCatalogSearchTable` twice; after structural patches, always scan the edited block for accidental duplicate component lines before running tests.
- 2026-02-20 - command quoting self-miss - I retriggered zsh glob expansion (`no matches found`) by reading App Router paths with `(...)` and `[...]` unquoted; always single-quote those paths in shell commands.
- 2026-02-20 - next-lint codemod gotcha - `@next/codemod next-lint-to-eslint-cli` updated this repo's `eslint.config.js` import but left `...compat.extends(...)`, causing `compat is not defined`; keep `FlatCompat` for the current `tseslint.config(...)` setup and migrate the npm script to scoped ESLint CLI targets (here `eslint src`) instead of blanket `eslint .`.
- 2026-02-20 - test env typing gotcha - `process.env.NODE_ENV` can be readonly in this TS setup; in tests mutate via `const mutableEnv = process.env as Record<string, string | undefined>` instead of direct assignment/delete.
- 2026-02-20 - dashboard button regression - Wrapping Clerk `SignInButton` with shadcn `Button asChild` and an inner `span` can render non-interactive dashboard text; keep a real `Button` as the child of `SignInButton` to preserve clickable role semantics.
- 2026-02-19 - test dependency assumption - `@testing-library/user-event` is not installed in this repo; use `fireEvent` from `@testing-library/react` for integration UI tests unless dependency is explicitly added.
- 2026-02-19 - jsdom popover gotcha - `cmdk`/Radix popover flows require a `ResizeObserver` polyfill in Vitest jsdom tests; add a minimal mock in the test when using faceted filters.
- 2026-02-19 - jsdom cmdk scroll gotcha - Faceted filter popovers may call `scrollIntoView`; add a no-op `HTMLElement.prototype.scrollIntoView` polyfill in the test when absent.
- 2026-02-19 - jsdom radix slider gotcha - Dual-thumb Radix slider key interactions can be inconsistent for exact step-value assertions in jsdom; keep integration assertions looser (range param exists) and verify exact range values in Playwright e2e.
- 2026-02-19 - TS test fixture inference - Unannotated fixture objects initialized with `null` infer `null`-only property types; declare an explicit interface (`string | null`) before using `Partial<...>` overrides.
- 2026-02-19 - test fixture typing - `RouterOutputs["public"]["getProfile"]` in unit tests rejects partial literal + direct cast; provide the full object shape (or intentionally cast via `unknown`) to keep `tsc --noEmit` green.
- 2026-02-19 - route path shell globbing - Unquoted paths containing `[...]` failed in zsh (`no matches found`). Quote route paths when reading/editing files under App Router dynamic segments.
- 2026-02-19 - header/mobile UX correction - User wants `/{slug}/search` header simplified (garden name + search/filter subheading + contact CTA) and wants mobile image panel restored on `/{slug}`.
- 2026-02-19 - static user pages redo - Re-implement PR #67 behavior from scratch on a fresh branch; use PR diff only as reference, keep component composition explicit, and avoid effect-driven derived state (follow React "You Might Not Need an Effect").
- 2026-02-19 - static SEO route pitfall - Reading `searchParams` in server `/{slug}` and `/{slug}/page/[page]` page/metadata made responses `private, no-store` at runtime even with `force-static`. For crawl-first static behavior, keep those server files query-agnostic and handle `?page` through middleware rewrite + `/page/[page]` params only.
- 2026-02-19 - suspense shell pitfall - Wrapping SEO profile/listings sections in `Suspense` without fallback produced shell-only initial body (`template B:*` + hidden stream payload) until JS applied it. Remove those wrappers on SEO pages when you want full content directly visible in first HTML response.
- 2026-02-19 - static first-response test pattern - Add a small `@local` E2E test that seeds a public profile, fetches raw HTML via Playwright `request`, and asserts first-document content includes profile/listings while excluding streamed-shell markers (`template id=\"B:*\"`, hidden `S:*` chunks). Keep cache-header assertions out of local dev mode.
- 2026-02-19 - e2e URL expectations - Dashboard listings filters now write plain query-string values (not JSON-quoted), so e2e `expectUrlParam` assertions should compare against raw tokens. Also with `force-static` profile page canonical redirects from `/{userId}` to `/{slug}` can drop non-page query params; tests should not assume `viewing`/`utm_*` survive that redirect.
- 2026-02-19 - e2e timeout flake - `manage-list-page-features` can timeout on first `page.goto('/dashboard/lists/:id')` during full-suite dev-server compile churn (passes in isolation). Mark the test `test.slow()` to align timeout budget with heavier route compile cost.
- 2026-02-19 - infinite query page params - `useInfiniteQuery` initial data in this repo expects `pageParams` with `undefined`, while `utils.public.getListings.setInfiniteData` expects `string | null`; avoid forcing one shape globally and let snapshot creation accept both (`string | null | undefined`), normalizing persisted values.
- 2026-02-19 - requestIdleCallback narrowing - In TS with DOM libs, checking `"requestIdleCallback" in window` can narrow the fallback branch to `never`; use global `setTimeout`/`clearTimeout` in fallback instead of `window.setTimeout`.
- 2026-02-19 - lint gotcha - `@typescript-eslint/no-empty-function` flags no-op cleanup lambdas; return `() => undefined` for intentional no-op cleanup in client helpers.
- 2026-02-19 - idb error handling - `void`-ing async IndexedDB writes/reads can still produce unhandled promise rejections; add explicit `.catch(() => undefined)` or `try/catch` in async effects.
- 2026-02-19 - lint regex style - ESLint prefers `RegExp#exec()` over `String#match()` in this repo (`@typescript-eslint/prefer-regexp-exec`).
- 2026-02-19 - test mocking gotcha - `CatalogSeoListings` pulls in `CatalogSeoPagination`, which uses `useRouter`; tests still need a minimal `next/navigation` mock even when assertions only check link hrefs.
- 2026-02-19 - route-type cache - Removing app routes can leave stale `.next/types/validator.ts` references; run `pnpm exec next typegen` before `tsc --noEmit`.
- 2026-02-19 - command sequencing mistake - Parallelized dependent `mkdir` + file-write commands and hit intermittent `no such file or directory`; run dependent path creation and writes sequentially.
- 2026-02-19 - command policy note - Direct `rm` commands can be blocked by policy in this environment; prefer `apply_patch` delete hunks for file removals.
- 2026-02-14 - dashboardDb cultivar refs - For main dashboard TanStack DB cutover, prefer cultivar-reference cache option (1): cache only refs referenced by the user's listings; keep listing payloads small (only `cultivarReferenceId`) and join locally for AHS display. Do not expose `ahsId` as a standalone field (nested `ahsListing` is OK for now).
- 2026-02-14 - dashboardDb persisted SWR - For faster reloads, hydrate dashboardDb collections from a per-user IndexedDB snapshot (toggle via a single const) then revalidate in background. Because sync endpoints are upserts-only (no deletions), schedule snapshot persistence after key mutations (especially deletes) to prevent resurrecting deleted rows on reload.
- 2026-02-14 - dashboardDb hardening - Provider should gate rendering on collection readiness (prevents "write before sync context" crashes) and purge `["dashboard-db"]` query cache + collection cleanup on logout/auth change to avoid cross-user flashes during debugging.
- 2026-02-14 - dashboardDb bootstrap - Factor the repeated init sequence (set current user, seed query cache, set cursor, clear tombstones, preload) into `bootstrapDashboardDbCollection` so it stays consistent across collections and is harder to regress.
- 2026-02-14 - dashboardDb cursors - For incremental sync, advance cursors to the max `updatedAt` observed in returned rows (and keep previous cursor on empty results). Setting cursor to "now" can permanently skip writes that occur during the sync window. Also: `collection.utils.refetch()` won't run if the underlying TanStack Query is disabled; keep query-collections `enabled: true`.
- 2026-02-14 - legacy listing status - Treat any legacy `status` values other than `STATUS.HIDDEN` as published/null so forms don't crash on `"published"` or `""`.
- 2026-02-13 - vercel build snapshot - Avoid downloading sqlite tools by scraping sqlite.org; use OS package install (Vercel/Amazon Linux via `dnf install sqlite`) or fail clearly. Build snapshot uses `USE_TURSO_DB_FOR_BUILD` and must not change runtime `USE_TURSO_DB`.
- 2026-02-12 - prisma artifacts - Do not commit generated Prisma client output (`prisma/generated/sqlite-client`) or SQLite DB files; commit schema + migration/source changes only.
- 2026-02-12 - next route config - Route-segment exports like `export const revalidate` and `export const dynamicParams` must stay literal in the page file; imported config/object property values can fail static parsing.
- 2026-02-12 - profile deep-link UX - For `?viewing=` on public profile, avoid transient “Listing not found”; fetch `public.getListing` when the ID is not in loaded pages and show a loading state until query resolves.
- 2026-02-12 - cleanup preference - For agent cleanup passes, user prefers concise readable code with minimal defensive noise; keep composition explicit and align tests to current data contracts (e.g. AHS-only hero images).
- 2026-02-11 - cultivar page revamp - User wants cultivar pages grouped by pro catalogs (not flat listings), with AHS hero image, no add-to-cart, and listing deep links via `/:slug?viewing=:listingId`.
- 2026-02-11 - routing migration - User chose global cultivar canonicals (`/cultivar/:normalizedName`) with cultivar pages showing all sellers, while legacy listing route should only redirect canonical `/:userId/:listingId` to `/:userSlug?viewing=:listingId`.
- 2026-02-12 - seo/crawling - For cultivar sitemap entries, avoid `lastModified: new Date()` noise; use real entity timestamps (cultivar/listing `updatedAt`) and include AHS image in cultivar OG/Twitter metadata when present.
- 2026-02-12 - cultivar slug canonical - User wants clean cultivar URL slugs (slugified, not URI-encoded punctuation) and sitemap/static generation aligned to listing-backed cultivars by config.
- 2026-02-12 - cultivar redesign - User wants conversion-first cultivar page with offers toolbar query params (`offerSort`, `offerForSale`, `offerHasPhoto`), no public add-photo CTA, and related cultivars limited to image-backed public pages.
- 2026-02-09 - ahs migration - User wants data migration SQL to be generated by script, not hand-authored, so reruns are deterministic and auditable.
- 2026-02-09 - conversion UX - Reused `FloatingCartButton` dialog state for a new top-of-profile `Contact Seller` CTA while keeping the bottom-right floating button.
- 2026-02-09 - product review correction - Public listing has a bottom-right floating contact/cart action; it was easy to miss in snapshots because icon-only controls lacked clear labels in the accessibility tree.
- 2026-02-09 - product review - When asked for customer-value feedback, run Playwright on public flows (home -> catalogs -> catalog -> listing -> auth modal) and prioritize activation, conversion, and retention gaps with concrete examples.
- 2026-02-09 - e2e observability - Force `NEXT_PUBLIC_SENTRY_ENABLED=false` in Playwright local config and `webServer.env` so local E2E never initializes Sentry.
- 2026-02-07 - e2e cleanup - Full suite stabilized after removing most custom timeout/retry/poll code and validating with repeats.
- 2026-02-07 - e2e issue - Profile content sometimes disappeared after reload due autosave race; fixed by waiting for `userProfile.updateContent` response after blur.
- 2026-02-07 - e2e issue - Clerk modal has variant state: after email click `Continue`; after code entry do not submit again (auto-submit). If warning says code wasn't sent, click `Continue` once.
- 2026-02-07 - e2e issue - Select/popup items can be outside viewport; `scrollIntoViewIfNeeded()` before click fixed intermittent failures.
- 2026-02-07 - e2e issue - Listings row-action dropdown was flaky in CI/local when relying on generic role selectors or `force: true`; stable approach is explicit row-action test IDs + menu-open assertions (trigger `aria-expanded`) before clicking action items.
- 2026-02-08 - e2e issue - Listings row-action still flaked when search query updates were still propagating; fix was to wait for URL query state (`expectUrlParam("query", value)`) before opening row actions.
- 2026-02-08 - e2e issue - `scrollIntoViewIfNeeded()` on row-action trigger can throw `Element is not attached to the DOM` during table re-render; direct locator `.click()` was more stable for this trigger.
- 2026-02-08 - e2e issue - URL-param assertions (`expect.poll` on `page.url()`) were flaky in CI/act despite correct UI behavior; replacing with table/page-indicator assertions removed false negatives.
- 2026-02-08 - e2e issue - `page.locator("table").first()` is brittle when pages render multiple tables; scope all row locators to container test ids (`list-table`, `manage-list-table`) to avoid wrong-table clicks and detach.
- 2026-02-09 - seo/public routes - Avoid `as const` on Prisma `where` filter objects (`OR` arrays become readonly and break Prisma + no-unsafe typing across route outputs).
- 2026-02-09 - tooling - `pnpm install` runs `prisma generate` and may rewrite generated client paths/binary targets to local machine values; revert generated noise before finalizing changes.
- 2026-02-10 - dual-write - User prefers Prisma ORM writes over raw SQL for dual-write paths; if cultivar reference rows are missing, throw explicit runtime error instead of auto-creating with raw SQL.
- 2026-02-10 - migration docs - For migration follow-ups, provide task breakdown as JSON with explicit `completed` boolean fields so lower-context agents can execute safely.
- 2026-02-10 - edit dialog bug - Unlinking AHS in `AhsListingLink` can be reverted on dialog close if `ListingForm` still holds stale `ahsId`; sync `ahsId` into form state on link/unlink success to prevent close-save from re-linking.
- 2026-02-10 - unlink/save regression - Better fix was decoupling: keep `ahsId` out of form schema/state and allow router `update` input to accept optional `ahsId` for link/unlink component calls only; this prevents Save from re-linking stale AHS data.
- 2026-02-10 - api boundary cleanup - Final simplification: `AhsListingLink` should call `listing.linkAhs`/`listing.unlinkAhs` directly; then `listing.update` can stay form-only (`listingFormSchema`) with no `ahsId` handling.
- 2026-02-11 - pre-merge stabilization - For AHS V2 flagged rollout, keep `syncAhsName` strict canonical (`cultivarReference.ahsListing` only), keep secret menu override client-only, and enforce data invariants with SQL checks in migration docs.
- 2026-02-11 - create dialog regression - Empty/whitespace title must fall back to selected AHS name (then default listing name) so create payload never sends blank titles.
- 2026-02-11 - type alignment - When router responses add derived `ahsListing` via `withDisplayAhsListing(s)`, hook return types must use `WithDisplayAhsListing<T>` and sibling routers (e.g. `list.getListings`) should return the same derived shape to avoid table generic mismatches.
- 2026-02-11 - e2e temp-db reset - `withTempE2EDb` must clear `CultivarReference` before `AhsListing`; otherwise retries leave orphaned refs (`ahsId` null) and deterministic seed upserts can fail unique on `CultivarReference.id`.
- 2026-02-13 - prisma db push - Prisma schema engine can fail to start when `RUST_LOG=warn`; set `RUST_LOG=info` (and clear `NODE_OPTIONS`) for `prisma db push` in scripts/tests.
- 2026-02-13 - tanstack db collections - `@tanstack/query-db-collection` write utils require sync context; start collection sync via `useLiveQuery` subscription or `await collection.preload()` (after seeding query cache) before calling `utils.writeInsert`/`writeUpdate`/`writeDelete`.
- 2026-02-13 - tanstack db SSR - Next can server-render client components; `useLiveQuery` can warn (`Missing getServerSnapshot`) if it hits SSR. Fix by rendering live-query components client-only (dynamic import `ssr:false` or mount-gate and put `useLiveQuery` in a child rendered only after `useEffect`).
- 2026-02-13 - data-table column filters - `useDataTable` URL-sync only tracks columns with `filterFn`; if a column shows a filter UI, ensure it sets `filterFn` (e.g. `fuzzyFilter`) or the filter can be dropped on search-param navigation.
- 2026-02-13 - e2e popover filters - Radix popover filter inputs can detach during URL-sync/table rerenders; in Playwright, target by exact placeholder and retry after `Escape` + reopen.
- 2026-02-13 - unit test env - Importing the full `appRouter` can eagerly construct clients (e.g. Stripe) and crash if env vars are missing even with `SKIP_ENV_VALIDATION=1`; set minimal placeholder env vars or import routers directly.

- 2026-02-19 - advanced search UX pattern - Range sliders should include paired number inputs (commit on blur/Enter) for precise value entry; accordion filter sections start collapsed with active-filter badge counts on triggers; removable filter chips bar between quick-filters and accordions replaces bottom reset/count footer; singleton controls (e.g. Lists) belong in the quick-filter row, not their own accordion.
- 2026-02-19 - search mode toggle - Replaced dual Basic/Advanced buttons with a single Switch toggle inside the filter card; the sidebar panel now renders in both modes (basic shows single input + quick filters, advanced adds accordions). This keeps the search UI always visible in a sidebar layout.
- 2026-02-20 - advanced search e2e maintenance - For `public-catalog-advanced-search.e2e.ts`, target behavior-level controls (mode switch, search input, accordion trigger labels, visible results/URL state) and avoid assuming sections are open by default.
- 2026-02-20 - stripe kv seeding for e2e - Seed `keyValue` entry `stripe:customer:<id>` in temp-db setup (use `setStripeSubscriptionStatus`) to avoid noisy Stripe fallback lookups for synthetic customer ids.

## Preferences

- For caching-related test updates, prioritize behavior-level assertions over implementation details; only update tests for intended behavior changes.
- For Next route segment config values that must remain literal (`revalidate`), include a searchable inline marker comment pointing to the canonical config constant (`CACHE_LITERAL_REF: ...`).
- Public pages caching target: static/ISR 24h for `/`, `/catalogs`, `/{slug}`, `/{slug}?page=n`, `/cultivar/{slug}`; keep `/{slug}/search` non-static + noindex with 24h SWR.
- Skip tests while caching behavior is being iterated experimentally unless explicitly asked to run or update them.
- TanStack DB internals should not be treated as cache for this experiment.
- Keep query params when redirecting public profile routes from `/{userId}` to `/{slug}`.
- Keep `/{userId}` -> `/{slug}` canonical redirects server-side (SEO), not client-side.
- Write tests, not too many, mostly integration, hapy path e2e.
- During quick UI iteration, skip writing/running tests until behavior is settled.
- Template controls on `/dashboard/tags` should use a shadcn-style picker (not native select), include per-row delete for saved templates inside the picker, and only show "Save as template" when current layout is custom.
- Built-in tag templates should be: `name + hybridizer + year + ploidy + qr` (default), `name + qr`, and `full detail` matching the photographed information structure.
- In `/dashboard/tags`, keep layout geometry deterministic across listings by rendering empty cells as blank text rather than omitting those cells.
- Tag-printing should ship as a dedicated dashboard page (`/dashboard/tags`), not as an embedded manage-list action.
- TanStack DB dashboard migration: keep procedures under new `dashboardDb` router, migrate main `/dashboard` page-by-page, and run `pnpm lint`, `npx tsc --noEmit`, `pnpm test`, `pnpm test:e2e` before each incremental commit.
- Cultivar pages should be catalog-centric (catalog cards with nested cultivar listing rows), not listing-card grids.
- Use composition patterns for new UI components (prefer explicit composed sections over boolean-mode props).
- Use the term `napkin` (not `codex napkin`).
- Keep E2E tests UI-only; if UI behavior fails, test should fail (don't hide with non-UI shortcuts).
- For Vercel production builds, prefer building against a local snapshot of the prod DB (to avoid slow remote Turso queries); preview builds can keep using Turso.
- Use a 3-step DB rollout for this repo's AHS migration work: Prisma structural migration, then generated SQL file for reference-table data load, then generated SQL file for listing backfill.
- Avoid `executeRawUnsafe` in application and migration-adjacent app code when Prisma ORM operations can do the job.
- For product-feedback asks, return prioritized recommendations tied to activation, conversion, and retention.
- During AHS V2 rollout, keep API inputs backward-compatible (`ahsId` + `cultivarReferenceId`) until post-cutover cleanup.
- For base profile -> catalog search CTA, carry only the `page` param (when present) and do not forward other search/filter params.
- For table URL sync, never JSON-quote plain string filter values; `lists` must parse as string-array even when a single ID is provided, otherwise faceted filter UI can show character-count selections.
- On public `/user` SEO listings UX, user wants a dedicated "Search and filter listings" CTA below the Listings heading, pagination controls at both top and bottom, and pagination navigation anchored back to `#listings`.
- SEO pagination on public `/user` should visually mirror the existing table pagination controls, but replace "Rows per page" with a "Go to page" selector.
- Updated preference: simplify public `/user` SEO pagination to sketch style `Page [select] of N` with only previous/next arrows, and align search CTA on the same row when space allows.
- Keep the top listings control row with search CTA left and pagination right; page-number select should auto-fit content instead of a fixed width.
- On public `/{slug}/search`, reuse the same profile header section as `/{slug}` (including contact/cart controls) and show `N total` beside the Listings heading.
- Follow-up UX correction: `/{slug}/search` header also needs the profile image panel (not just text/stats/buttons), matching the `/user` header layout.
- On public `/{slug}` section nav, include a `Search/filter` link to `/{slug}/search`, carrying only the `page` param when present.
- Hide profile image panel on mobile for public profile header layouts (`/{slug}` and `/{slug}/search`) to prioritize text/actions and reduce above-the-fold height.
- Updated UX preference: `/{slug}/search` should use a lean search-focused header (garden name + search/filter subheading + Contact Seller button), and `/{slug}` should show the profile image panel on mobile again.
- Updated pagination preference: use a dedicated `/{slug}` listings page-size constant (set to 100) instead of shared table defaults, and show pagination both above and below listings (top control to the right of search CTA on larger screens, below it on small screens).
- Route naming update: public interactive search page uses `/{slug}/search`; keep `/{slug}/catalog` as a compatibility redirect.
- Updated preference: do not keep `/{slug}/catalog` compatibility redirect since it was introduced and removed within this PR; keep only `/{slug}/search`.
- Search UX preference: `/{slug}/search` should provide both all-fields search and title-only search, and pressing `Enter` in the search form should scroll to the listings summary so the `x / n listings` context stays visible.
- Listing card UX preference: on `/{slug}` and `/{slug}/search`, titles should wrap and shrink before truncation, with middle truncation only past a hard upper-length cap.
- `/{slug}` lists section preference: show a `For Sale` list card when the catalog has any for-sale listings, linking to `/{slug}/search?price=true`.
- `/{slug}` SEO listings pagination preference: sort for-sale listings first, then keep the existing alphabetical ordering rules within that group.

## Patterns That Work

- Simplify first: remove stability scaffolding, then re-add only minimal waits tied to real UI/events when failures prove necessary.
- Use `--repeat-each` to prove changes: spec-level `--repeat-each 3` while iterating, then suite-level `tests/e2e/*.e2e.ts --repeat-each 2`.
- Prefer UI signals (visible/enabled/url/assertions) over polling and explicit timeouts.
- For Radix dropdown interactions in table rows, use open-menu assertions (`data-state=\"open\"`) and action-specific selectors instead of structural table locators (`table.last()`, `aria-controls`).
- Scope table interactions to test-id containers first, then table internals (avoid global `table.first()` selectors).

## Patterns That Fail

- Preemptive "stability" code (long custom timeouts, retry loops, blanket force-clicks) made tests harder to reason about.
- Reloading immediately after EditorJS typing without waiting for save completion caused flaky assertions.
- Pressing submit after entering Clerk verification code added instability; code field completion should auto-submit.
- Row-action flows tied to table re-renders can detach menu items mid-click; generic `getByRole(\"menuitem\")` across the page is brittle.
- `scrollIntoViewIfNeeded()` is not universally safer; on rapidly rerendering table rows it can increase detach failures.
- URL-state polling as a primary assertion layer can fail even when the visible table state is correct.

## Domain Notes

- Occasional server-side `ECONNRESET` or transient tRPC errors may appear during runs; prioritize actual test assertion failures over noisy logs.
- 2026-02-20 - codemod version detection gotcha - `@next/codemod upgrade` can treat the installed `node_modules` Next version as current even if `package.json` is older; run `pnpm install` first when package files were reverted without reinstalling.
- 2026-02-20 - next16 lint migration pattern - Moving to `eslint-config-next@16` with flat config surfaces `react-hooks/set-state-in-effect`; resolving by deriving state / ref-based guards (instead of disabling the rule) keeps lint clean with Next 16 recommendations.
- 2026-02-20 - repeat globbing self-miss - I still triggered zsh `no matches found` by running `rg/sed` against unquoted App Router paths with `[listId]`; quote dynamic segment paths every time in shell commands.
- 2026-02-20 - column parity pattern - To prevent dashboard/manage-list divergence, compose manage-list columns from `baseListingColumns` and only add local utility columns like `select`.
- 2026-02-20 - globbing recurrence - I repeated the `[listId]` quoting miss again during `git diff`; always quote these paths even in final status/diff commands.
- 2026-02-20 - tag designer compaction - Refactored 9 always-visible full-width field cards into two-tier layout: compact checkbox grid for inclusion, inline settings row only for included fields. ~70% vertical space reduction with defaults.
- 2026-02-20 - print iframe blank fix - Two issues: (1) zero-dimension + `visibility:hidden` skips layout, fix with off-screen positioning at real dims; (2) `iframe.onload` fires for the initial `about:blank` page before `document.write` adds content, causing `didPrint` to latch true and print a blank page. Fix by removing the premature `onload` handler and using only a single `setTimeout` after `document.close()`.
- 2026-02-20 - tag field settings grid - Converted flex-wrap field settings rows to CSS grid with Fragment-based rows so columns align vertically across fields. Added per-field `textAlign` property for independent left/right justify on printed tags.
