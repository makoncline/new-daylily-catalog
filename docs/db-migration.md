# Database Migration Workflow

This document defines the default migration process for this repo.

## Core Approach

Use a 3-step migration model:

1. Structural changes: Prisma-generated migration SQL in `prisma/migrations/...`.
2. Data changes: deterministic SQL files generated by script into `prisma/data-migrations/...`.
3. Apply the same SQL files in the same order for local verification and production.

## Rules

- Structural SQL must come from Prisma schema changes.
- Data SQL should be generated by script, not written manually each run.
- Data SQL must be deterministic and idempotent.
- Local validation is required before production apply.
- Do not use `pnpm env:dev -- ...` (this causes `spawn -- ENOENT`).
- Always run env wrapper commands as `pnpm env:dev <command>`.

## Step 0: Create Local Prod Copy (Recommended)

Run backup script using your local env token:

```bash
pnpm env:dev bash scripts/db-backup.sh
```

This creates:

```text
prisma/local-prod-copy-daylily-catalog.db
```

## Step 1: Generate Structural Migration (Prisma)

1. Update `prisma/schema.prisma`.
2. Generate migration SQL (create-only):

```bash
NODE_OPTIONS='' RUST_LOG=info npx dotenv -e .env.development -- \
  npx prisma migrate dev --create-only --name <migration_name>
```

This creates:

```text
prisma/migrations/<timestamp>_<migration_name>/migration.sql
```

If `migrate dev --create-only` fails on a local copy, generate SQL by diff:

```bash
npx prisma migrate diff \
  --from-url file:./prisma/local-prod-copy-daylily-catalog.db \
  --to-schema-datamodel prisma/schema.prisma \
  --script > prisma/migrations/<timestamp>_<migration_name>/migration.sql
```

## Step 2: Generate Deterministic Data SQL

1. Create or update a generator script in `scripts/` (TypeScript preferred).
2. Script writes SQL artifacts into `prisma/data-migrations/`.
3. Run generator:

```bash
pnpm data-migrations:generate
```

Example generator output:

```text
prisma/data-migrations/20260209_populate_cultivar_reference_from_ahs.sql
prisma/data-migrations/20260209_backfill_listing_cultivar_reference_id.sql
```

## Step 3: Apply Locally (Same Order as Production)

Use the local copy DB for verification:

```bash
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/migrations/<timestamp>_<migration_name>/migration.sql
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/data-migrations/<first_data_sql>.sql
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/data-migrations/<second_data_sql>.sql
```

Run validation queries after apply (counts, coverage, orphan checks, etc.).

## Step 4: Apply to Production (After Local Validation)

Take a fresh backup first:

```bash
pnpm env:dev bash scripts/db-backup.sh
```

Apply the exact same SQL files in the exact same order:

```bash
turso db shell daylily-catalog < prisma/migrations/<timestamp>_<migration_name>/migration.sql
turso db shell daylily-catalog < prisma/data-migrations/<first_data_sql>.sql
turso db shell daylily-catalog < prisma/data-migrations/<second_data_sql>.sql
```

## Commit Requirements

Each migration PR should include:

- `prisma/schema.prisma` changes.
- Generated structural migration SQL under `prisma/migrations/`.
- Data SQL generator script under `scripts/` (or updated existing generator).
- Generated data SQL under `prisma/data-migrations/`.
- Validation notes (counts/checks) from local apply.
