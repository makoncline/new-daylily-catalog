# Cultivar Reference Migration (AHS V2) (completed 2026-02-11)

This document captures the concrete process used for the cultivar-reference migration.

## Purpose

- Populate `CultivarReference` from `AhsListing`.
- Backfill `Listing.cultivarReferenceId` for existing linked listings.
- Keep migration deterministic across local, stage, and production.

## Artifacts

Structural migration SQL:

- `prisma/migrations/<timestamp>_<migration_name>/migration.sql`

Deterministic data SQL artifacts (generated by script):

- `prisma/data-migrations/20260209_populate_cultivar_reference_from_ahs.sql`
- `prisma/data-migrations/20260209_backfill_listing_cultivar_reference_id.sql`

Generator script:

- `scripts/generate-cultivar-reference-data-sql.ts`

## Execution Order

Always run in this order:

1. Structural migration SQL.
2. Populate cultivar reference SQL.
3. Listing backfill SQL.

### Local

```bash
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/migrations/<timestamp>_<migration_name>/migration.sql
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/data-migrations/20260209_populate_cultivar_reference_from_ahs.sql
sqlite3 prisma/local-prod-copy-daylily-catalog.db < prisma/data-migrations/20260209_backfill_listing_cultivar_reference_id.sql
```

### Stage

```bash
turso db shell daylily-catalog-stage < prisma/migrations/<timestamp>_<migration_name>/migration.sql
turso db shell daylily-catalog-stage < prisma/data-migrations/20260209_populate_cultivar_reference_from_ahs.sql
turso db shell daylily-catalog-stage < prisma/data-migrations/20260209_backfill_listing_cultivar_reference_id.sql
```

### Production

```bash
pnpm env:dev bash scripts/db-backup.sh

turso db shell daylily-catalog < prisma/migrations/<timestamp>_<migration_name>/migration.sql
turso db shell daylily-catalog < prisma/data-migrations/20260209_populate_cultivar_reference_from_ahs.sql
turso db shell daylily-catalog < prisma/data-migrations/20260209_backfill_listing_cultivar_reference_id.sql
```

## Validation Queries

Run after apply in local/stage/prod.

```sql
-- Count parity between source AHS and CultivarReference
SELECT COUNT(*) AS ahs_count FROM "AhsListing";
SELECT COUNT(*) AS cultivar_reference_count FROM "CultivarReference";

-- Listing backfill coverage
SELECT COUNT(*) AS listings_with_ahs
FROM "Listing"
WHERE "ahsId" IS NOT NULL;

SELECT COUNT(*) AS listings_with_ahs_and_cultivar_ref
FROM "Listing"
WHERE "ahsId" IS NOT NULL
  AND "cultivarReferenceId" IS NOT NULL;

-- Invariant checks (must be 0)
SELECT COUNT(*) AS orphaned_listing_cultivar_refs
FROM "Listing" l
LEFT JOIN "CultivarReference" cr ON cr."id" = l."cultivarReferenceId"
WHERE l."cultivarReferenceId" IS NOT NULL
  AND cr."id" IS NULL;

SELECT COUNT(*) AS ahs_mismatch_count
FROM "Listing" l
JOIN "CultivarReference" cr ON cr."id" = l."cultivarReferenceId"
WHERE l."ahsId" IS NOT NULL
  AND cr."ahsId" IS NOT NULL
  AND l."ahsId" != cr."ahsId";

SELECT COUNT(*) AS legacy_ahs_without_cultivar_ref
FROM "Listing"
WHERE "ahsId" IS NOT NULL
  AND "cultivarReferenceId" IS NULL;
```

Acceptance targets:

- `cultivar_reference_count` matches `ahs_count`.
- `listings_with_ahs_and_cultivar_ref` matches `listings_with_ahs`.
- All invariant checks above return `0`.

## Recorded Production Verification (latest run)

- `ahs_count`: `104269`
- `cultivar_reference_count`: `104269`
- `listings_with_ahs`: `6420`
- `listings_with_ahs_and_cultivar_ref`: `6420`
- `orphaned_listing_cultivar_refs`: `0`
- `ahs_mismatch_count`: `0`

## Failure Policy

If any invariant check fails:

1. Do not enable cultivar-reference-only runtime behavior in that environment.
2. Re-run populate/backfill migration SQL.
3. Re-run validation queries and confirm all checks pass.
