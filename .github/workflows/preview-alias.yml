name: Alias Vercel Preview

on:
  deployment_status:

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  alias:
    if: >
      github.event.deployment_status.state == 'success' &&
      (github.event.deployment.environment == 'Preview' || github.event.deployment.environment == 'preview')
    runs-on: ubuntu-latest
    steps:
      - name: Compute values
        id: vals
        run: |
          echo "URL=${{ github.event.deployment_status.environment_url }}" >> $GITHUB_OUTPUT
          echo "SHA=${{ github.event.deployment.sha }}" >> $GITHUB_OUTPUT
          echo "HASH=$(echo '${{ github.event.deployment.sha }}' | cut -c1-8)" >> $GITHUB_OUTPUT

      - name: Alias to <hash>.deploy-preview.daylilycatalog.com
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM: ${{ secrets.VERCEL_TEAM }}
          URL: ${{ steps.vals.outputs.URL }}
          HASH: ${{ steps.vals.outputs.HASH }}
        run: |
          ALIAS="${HASH}.deploy-preview.daylilycatalog.com"
          # sanity check scope / login
          npx vercel whoami --token "$VERCEL_TOKEN" --scope "$VERCEL_TEAM"
          # optional: confirm domain is visible in this scope
          npx vercel domains ls --token "$VERCEL_TOKEN" --scope "$VERCEL_TEAM"
          # alias within the correct team
          npx vercel alias set "$URL" "$ALIAS" --token "$VERCEL_TOKEN" --scope "$VERCEL_TEAM"

      - name: Comment alias URL on PR
        uses: actions/github-script@v7
        env:
          SHA: ${{ steps.vals.outputs.SHA }}
          HASH: ${{ steps.vals.outputs.HASH }}
        with:
          script: |
            const marker = "<!-- preview-alias-url -->";
            const aliasUrl = `https://${process.env.HASH}.deploy-preview.daylilycatalog.com`;
            const body = `${marker}\nPreview alias is ready: [${aliasUrl}](${aliasUrl})`;
            const { owner, repo } = context.repo;

            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: process.env.SHA,
            });

            const pr = prs.find((candidate) => candidate.state === "open") ?? prs[0];
            if (!pr) {
              core.info(`No PR found for commit ${process.env.SHA}; skipping comment.`);
              return;
            }

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr.number,
              per_page: 100,
            });

            const existing = comments.find(
              (comment) =>
                comment.user?.type === "Bot" &&
                comment.body?.includes(marker),
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body,
              });
              core.info(`Updated alias comment on PR #${pr.number}.`);
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr.number,
              body,
            });
            core.info(`Posted alias comment on PR #${pr.number}.`);
